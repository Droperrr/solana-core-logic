# Реализация алгоритма обработки CPI (Cross-Program Invocation)

## Обзор

В этом документе описана реализация алгоритма обработки вложенных инструкций (CPI) в транзакциях Solana. Основная цель - корректное распознавание сложных операций, таких как мультихоп-свопы через агрегаторы.

## Реализованный алгоритм

Алгоритм реализован в классе `UniversalParser` в файле `parser/universal_parser.py`. Основные компоненты реализации:

1. **Предварительная обработка транзакции**:
   - Метод `_preprocess_transaction_with_cpi` анализирует транзакцию на наличие вложенных инструкций
   - Создается словарь `inner_instructions_map` для быстрого доступа к вложенным инструкциям по индексу родительской инструкции

2. **Определение агрегаторов**:
   - Список известных агрегаторов хранится в атрибуте `aggregator_programs`
   - При обнаружении инструкции от известного агрегатора, анализируются ее вложенные инструкции

3. **Анализ изменений балансов токенов**:
   - Метод `_calculate_token_balance_changes` вычисляет изменения балансов токенов до и после транзакции
   - Создается словарь, где ключом является пара (owner, mint), а значением - изменение баланса

4. **Определение токенов для SWAP**:
   - Метод `_determine_swap_tokens` анализирует изменения балансов для определения токенов входа и выхода
   - Реализована приоритетная логика для различных сценариев SWAP:
     - SOL -> другой токен
     - Другой токен -> SOL
     - Другой токен -> другой токен

5. **Генерация высокоуровневого события**:
   - При успешном определении SWAP операции создается одно событие типа `SWAP`
   - Событие содержит информацию о токенах входа/выхода, суммах и агрегаторе

## Особенности реализации

1. **Обработка кортежей в ключах словаря**:
   - Для решения проблемы сериализации кортежей в JSON при отладке реализовано безопасное логирование
   - В событии SWAP не включается полный словарь `token_changes`, чтобы избежать проблем с сериализацией

2. **Приоритетная логика для SOL**:
   - Wrapped SOL (So11111111111111111111111111111111111111112) имеет приоритет при определении токенов для SWAP
   - Это улучшает точность определения операций SOL <-> токен

3. **Защита от ошибок**:
   - Реализована проверка на различные форматы данных (например, `accountKeys` может быть списком или объектом с `keyMetaList`)
   - Добавлены проверки на наличие необходимых полей в транзакции

## Тестирование

Для тестирования реализации создан скрипт `test_cpi.py`, который проверяет корректность обработки транзакции с мультихоп-свопом:

1. **Проверка структуры события**:
   - Тип события должен быть `SWAP`
   - Событие должно содержать поля `token_in_mint`, `token_out_mint`, `token_in_amount`, `token_out_amount`

2. **Проверка корректности определения токенов**:
   - Для тестовой транзакции `2S9wtoK2dYtnbPzrT3nXjsxzuMPRGNKVvMt9iT8nQomdMnVK8aTbtbzaybZ7HBVrBVHbv4MQvGtFmZ2Kudjc9ucK`:
     - `token_in_mint` должен быть `So11111111111111111111111111111111111111112` (Wrapped SOL)
     - `token_out_mint` должен быть `AL2HhMQLkJqeeK5w4akoogzyYBZ6GYkBfxjscCf2L2yC`

3. **Проверка версии парсера**:
   - Версия парсера должна содержать суффикс `-cpi`, указывающий на использование алгоритма обработки CPI

## Дальнейшие улучшения

1. **Расширение списка агрегаторов**:
   - Добавление поддержки других популярных агрегаторов и DEX

2. **Улучшение определения типа операции**:
   - Реализация более точного определения типа операции на основе анализа вложенных инструкций
   - Поддержка других типов операций, использующих CPI (например, предоставление ликвидности)

3. **Оптимизация производительности**:
   - Кеширование результатов анализа для повторяющихся паттернов инструкций
   - Оптимизация алгоритма для обработки большого количества транзакций

4. **Улучшение тестирования**:
   - Создание тестов для различных сценариев SWAP и других операций
   - Автоматизация регрессионного тестирования для проверки корректности обработки CPI 