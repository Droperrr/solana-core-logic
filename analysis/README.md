# Analysis (Аналитический Модуль)

## Назначение

Это "мозг" всего проекта. Директория `analysis` содержит инструменты, скрипты и ноутбуки для проведения исследований на основе данных, собранных и обработанных конвейером. Если `decoder` и `db` — это "руки", которые собирают и складируют сырье, то `analysis` — это "голова", которая извлекает из этого сырья ценные знания.

Здесь происходит проверка гипотез, поиск паттернов, обнаружение аномалий и бэктестинг торговых стратегий.

## Структура

```mermaid
graph TD
    subgraph "Data Source"
        A[База данных (SQLite)]
    end

    subgraph "Analysis Tools & Scripts"
        B(data_provider.py) --> C{Jupyter Notebooks};
        B --> D[Скрипты анализа];
        B --> E[Бэктестинг];
    end
    
    subgraph "Output"
        F(Отчеты / Визуализации)
        G(Результаты тестов)
    end

    A --> B;
    C --> F;
    D --> F;
    E --> G;

    style A fill:#A9D1F7,stroke:#333,stroke-width:2px
```

## Ключевые файлы и директории

### `notebooks/`
- **Назначение**: Исследовательская работа.
- **Роль**: Содержит Jupyter-ноутбуки. Это идеальная среда для интерактивного анализа данных, визуализации и быстрой проверки гипотез перед тем, как превращать их в полноценные скрипты.

### `strategies/`
- **Назначение**: Описание торговых стратегий.
- **Роль**: Здесь, вероятно, хранятся формализованные описания стратегий, которые затем можно проверить с помощью движка бэктестинга.

### `backtesting/`
- **Назначение**: Проверка стратегий на исторических данных.
- **Роль**: Содержит инструменты для "прогона" торговых стратегий на данных, которые уже произошли. Это позволяет оценить потенциальную эффективность стратегии, не рискуя реальными средствами.
    - `backtesting_engine.py`: Ядро системы бэктестинга.

### `data_provider.py`
- **Назначение**: Поставщик данных для анализа.
- **Роль**: Предоставляет удобный и унифицированный доступ к данным из базы. Вместо того чтобы каждый скрипт писал свои SQL-запросы, они обращаются к этому модулю, который возвращает данные в готовом для анализа виде (например, в формате Pandas DataFrame).

### `feature_library.py`
- **Назначение**: Библиотека признаков (фичей).
- **Роль**: Содержит функции для расчета различных признаков, которые могут быть полезны для машинного обучения. Например, "скользящее среднее объема торгов за 7 дней" или "количество транзакций за час".

### Скрипты анализа (например, `anomaly_detection.py`, `patterns.py`)
- **Назначение**: Выполнение конкретных аналитических задач.
- **Роль**: Это скрипты, которые реализуют определенную логику: поиск аномалий, выявление поведенческих паттернов, анализ активности по группам кошельков и т.д.

## Архитектура и ключевые файлы
- `analyzer.py` — Главная точка buy/sell-анализа, функция `determine_buy_sell` (использует декомпозированные методы из analyzer_rules).
- `analyzer_rules.py` — dataclass `BuySellResult` и вспомогательные методы анализа (по token_transfers, inner_instructions, балансу). Пока реализованы как заглушки (TODO).
- `initial_buy_pattern.py` — SQL-детектор паттерна "точные первые покупки" (Exact First Buys) по всем кошелькам.
- `patterns.py` — Детекторы сложных паттернов на уровне инструкций (managed transfer, bundled transfer, temp ATA swap). Все функции принимают разобранные инструкции и возвращают bool/детали.
- `qc_check.py` — Расширенный QC-скрипт: анализ пропусков, дубликатов, orphan-записей, enrich_errors, gap analysis и др. Выводит отчёт в консоль (использует pandas/tabulate).
- `auto_qc_alert.py` — Автоматический запуск QC-скрипта, запись отчёта и алертов в логи (`logs/qc_report.log`, `logs/qc_alerts.log`).
- `db_shell.py` — CLI-утилиты для просмотра структуры БД, примеров enrichment, поиска крупных сделок, etc. Запускать как `python analysis/db_shell.py`.
- `retry_failed_enrichment.py` — Перезапуск enrichment для транзакций с enrich_errors (использует process_single_transaction из processing).
- `get_sample_signatures.py` — Получить по одной сигнатуре для каждого типа транзакции (buy/sell/transfer/failed/account_management).
- `cleanup_orphan_token_transfers.py` — Удаление пустых/орфанных записей из token_transfers.
- `test_enrichment_pipeline.py` — Пример интеграционного теста enrichment (использует реальные сигнатуры и process_single_transaction).
- `get_sample_signatures.sql` — SQL-скрипт для выборки примеров транзакций по типам.

### Документация и чек-листы
- `enrichment_audit_checklist.md` — Чек-лист для аудита enrichment.
- `enrichment_audit_questions.md` — Вопросы для экспертов по QC/enrichment.
- `Итоговые рекомендации по enrichment и ан.ini` — Best practices по enrichment SOL/WSOL, структуре данных, ML-агрегатам.
- `audit_sonnet37.md` — Комплексный аудит архитектуры пайплайна.

## Примеры запуска
- QC-отчёт: `python analysis/qc_check.py` (выводит подробный отчёт по качеству данных)
- Авто-QC и алерты: `python analysis/auto_qc_alert.py` (создаёт логи в logs/)
- Shell-утилиты: `python analysis/db_shell.py` (выведет структуру БД, примеры enrichment, buy-сделки и др.)
- Повторный enrichment: `python analysis/retry_failed_enrichment.py`
- Очистка орфанных transfer: `python analysis/cleanup_orphan_token_transfers.py`

## Тесты
- Юнит-тесты для buy/sell-анализа: `tests/analysis/test_analyzer_rules.py` (pytest)
- Интеграционный тест enrichment: `analysis/test_enrichment_pipeline.py`
- Для запуска всех тестов: `pytest tests/analysis/`

## Best practices
- Все SQL-запросы и паттерны вынесены в отдельные функции для переиспользования.
- Для всех enrichment- и QC-метрик есть чек-листы и вопросы для аудита.
- Рекомендации по структуре enrichment и ML-агрегатам — в `Итоговые рекомендации по enrichment и ан.ini`.
- Для новых паттернов — добавлять отдельные функции в patterns.py, покрывать тестами.

## Ограничения и TODO
- Логика buy/sell-анализа в analyzer_rules.py пока реализована как заглушки (TODO).
- Не все edge-cases enrichment покрыты автотестами — см. чек-листы.
- Для production-использования рекомендуется централизовать конфиги и переменные окружения.

## Ссылки
- [Комплексный аудит архитектуры](audit_sonnet37.md)
- [Чек-лист enrichment](enrichment_audit_checklist.md)
- [Вопросы по QC](enrichment_audit_questions.md)
- [Best practices enrichment](Итоговые рекомендации по enrichment и ан.ini) 